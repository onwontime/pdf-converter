<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>PDF ì´ë¯¸ì§€ ë³€í™˜ê¸° + OCR PDF ë‹¤ìš´ë¡œë“œ (ê¸°ëŠ¥ ê°œì„ )</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5.0.4/dist/tesseract.min.js'></script>
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.min.mjs" type="module"></script>
  <style>
    body {
      font-family: "Inter", sans-serif;
      background-color: #f4f7f6;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      background-color: #ffffff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
      width: 100%;
      max-width: 1200px;
      text-align: center;
    }
    .image-block {
      cursor: pointer;
      transition: background-color 0.2s, border-color 0.2s; /* border-color ì „í™˜ íš¨ê³¼ ì¶”ê°€ */
      background: white;
      border-radius: 8px;
      padding: 10px;
      text-align: center;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
      display: flex; /* Flexboxë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ë¯¸ì§€ì™€ ìš”ì†Œë“¤ì„ ì„¸ë¡œë¡œ ë°°ì¹˜ */
      flex-direction: column;
      align-items: center;
      position: relative; /* í…ìŠ¤íŠ¸ ì˜ì—­ ìœ„ì¹˜ ì¡°ì •ì„ ìœ„í•´ */
      border: 2px solid transparent; /* ê¸°ë³¸ íˆ¬ëª… í…Œë‘ë¦¬ */
    }
    .image-block:hover {
      background-color: #edf2f7;
    }
    .image-block.selected {
      background-color: #bee3f8;
      border-color: #4299e1; /* ì„ íƒ ì‹œ í…Œë‘ë¦¬ ìƒ‰ìƒ */
    }
    /* OCR ë³€í™˜ ì™„ë£Œëœ í˜ì´ì§€ì— í…Œë‘ë¦¬ ì¶”ê°€ */
    .image-block.ocr-processed {
        border-color: #4272e1; /* ë‚¨ìƒ‰ í…Œë‘ë¦¬ */
    }

    .grid-output {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); /* ë°˜ì‘í˜• ê·¸ë¦¬ë“œ */
      gap: 1rem;
      margin-top: 1rem; /* ì„ íƒ íŒ¨ë„ê³¼ì˜ ê°„ê²© */

      position: relative; /* ë“œë˜ê·¸ ì„ íƒì„ ìœ„í•´ í•„ìš” */
      user-select: none;  /* ë“œë˜ê·¸ ì¤‘ í…ìŠ¤íŠ¸ ì„ íƒ ë°©ì§€ */
    }
    .action-btn { /* ëª¨ë“  ì•¡ì…˜ ë²„íŠ¼ì— ê³µí†µ ìŠ¤íƒ€ì¼ ì ìš© */
      display: inline-block;
      margin: 0.3rem; /* ë²„íŠ¼ ê°„ ê°„ê²© ì¡°ì • */
      padding: 8px 16px; /* íŒ¨ë”© ì¡°ì • */
      font-weight: bold;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      text-decoration: none;
      font-size: 0.9em; /* í°íŠ¸ í¬ê¸° ì¡°ì • */
    }
    .primary-btn { /* ì£¼ìš” ì•¡ì…˜ ë²„íŠ¼ (ë³€í™˜, ë‹¤ìš´ë¡œë“œ) */
        background-color: #4299e1;
        color: white;
    }
    .primary-btn:hover {
        background-color: #3182ce;
    }
    .danger-btn { /* ì •ì§€ ë²„íŠ¼ */
        background-color: #e53e3e; /* ë¹¨ê°„ìƒ‰ */
        color: white;
    }
    .danger-btn:hover {
        background-color: #c53030; /* ë” ì§„í•œ ë¹¨ê°„ìƒ‰ */
    }
     .action-btn:disabled { /* ë¹„í™œì„±í™” ìŠ¤íƒ€ì¼ */
        background-color: #a0aec0; /* íšŒìƒ‰ */
        cursor: not-allowed;
     }

    /* ìƒˆë¡œìš´ ë²„íŠ¼ ìŠ¤íƒ€ì¼: ì™¸ê³½ì„ , í°ìƒ‰ ë°°ê²½ */
    .outline-btn {
        background-color: white;
        color: #4299e1; /* ê¸°ë³¸ í…ìŠ¤íŠ¸ ìƒ‰ìƒ */
        border: 2px solid #4299e1; /* ì™¸ê³½ì„  ìƒ‰ìƒ */
    }
    .outline-btn:hover {
        background-color: #ebf8ff; /* í˜¸ë²„ ì‹œ ì—°í•œ íŒŒë€ìƒ‰ ë°°ê²½ */
        color: #3182ce; /* í˜¸ë²„ ì‹œ í…ìŠ¤íŠ¸ ìƒ‰ìƒ */
        border-color: #3182ce; /* í˜¸ë²„ ì‹œ ì™¸ê³½ì„  ìƒ‰ìƒ */
    }
     .outline-btn:disabled { /* ë¹„í™œì„±í™” ìŠ¤íƒ€ì¼ */
        background-color: #ffffff; /* í°ìƒ‰ ë°°ê²½ ìœ ì§€ */
        color: #a0aec0; /* íšŒìƒ‰ í…ìŠ¤íŠ¸ */
        border-color: #a0aec0; /* íšŒìƒ‰ ì™¸ê³½ì„  */
        cursor: not-allowed;
     }


    /* íŒŒì¼ëª… í‘œì‹œë¥¼ ìœ„í•œ ìŠ¤íƒ€ì¼ */
    #selectedFileName {
      margin-bottom: 1rem; /* ìƒíƒœ ë©”ì‹œì§€ì™€ì˜ ê°„ê²© */
      font-weight: bold;
      color: #333;
    }
    /* ìƒíƒœ ë©”ì‹œì§€ì™€ ì •ì§€ ë²„íŠ¼ì„ ë‹´ì„ ì»¨í…Œì´ë„ˆ */
    .status-container {
        display: flex;
        align-items: center;
        justify-content: center; /* ì¤‘ì•™ ì •ë ¬ */
        margin-bottom: 1rem; /* í•˜ë‹¨ ì—¬ë°± */
        min-height: 1.5em; /* ìƒíƒœ ë©”ì‹œì§€ê°€ ì—†ì„ ë•Œ ë†’ì´ ìœ ì§€ */
    }
    .status-container #status {
        margin-bottom: 0; /* ìƒíƒœ ë©”ì‹œì§€ ìì²´ í•˜ë‹¨ ì—¬ë°± ì œê±° */
        margin-right: 10px; /* ë²„íŠ¼ê³¼ì˜ ê°„ê²© */
    }
    /* ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ê·¸ë£¹ì„ ìœ„í•œ ìŠ¤íƒ€ì¼ */
    .download-buttons-group {
        margin-top: 1rem; /* ìƒë‹¨ ì—¬ë°± ì¶”ê°€ */
        margin-bottom: 1rem; /* í•˜ë‹¨ ì—¬ë°± ì¶”ê°€ */
        /* text-align: center; /* ì¤‘ì•™ ì •ë ¬ ìœ ì§€ */
    }
     /* OCR ì–¸ì–´ ì„ íƒ ë“œë¡­ë‹¤ìš´ ìŠ¤íƒ€ì¼ */
    #languageSelect {
        margin-left: 1rem; /* ë²„íŠ¼ê³¼ì˜ ê°„ê²© */
        padding: 8px;
        border-radius: 8px;
        border: 1px solid #cbd5e0;
        font-size: 0.9em;
    }
     /* OCR PSM ì„ íƒ ë“œë¡­ë‹¤ìš´ ìŠ¤íƒ€ì¼ */
    #psmSelect {
        margin-left: 1rem; /* ë²„íŠ¼ê³¼ì˜ ê°„ê²© */
        padding: 8px;
        border-radius: 8px;
        border: 1px solid #cbd5e0;
        font-size: 0.9em;
    }
    /* ì„ íƒ íŒ¨ë„ ì¢Œì¸¡ ì •ë ¬ ë° ìƒë‹¨ ì—¬ë°± */
    #selectionPanel {
        text-align: left; /* ì¢Œì¸¡ ì •ë ¬ */
        margin-top: 1rem; /* ìƒíƒœ ë©”ì‹œì§€ ì»¨í…Œì´ë„ˆì™€ì˜ ê°„ê²© */
        margin-bottom: 1rem; /* í˜ì´ì§€ ë¯¸ë¦¬ë³´ê¸°ì™€ì˜ ê°„ê²© */
    }

    /* OCR í…ìŠ¤íŠ¸ ì˜ì—­ ìŠ¤íƒ€ì¼ (ë” ì´ìƒ ì‚¬ìš©ë˜ì§€ ì•ŠìŒ) */
    .ocr-text {
        display: none;
    }

    /* í…ìŠ¤íŠ¸ ë³´ê¸° ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 100;
        display: none; /* ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€ */
    }

    .modal-content {
        background-color: #ffffff;
        padding: 20px;
        border-radius: 8px;
        max-width: 90%; /* ìµœëŒ€ ë„ˆë¹„ ì¦ê°€ */
        max-height: 90%; /* ìµœëŒ€ ë†’ì´ ì¦ê°€ */
        overflow-y: auto;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        display: flex;
        flex-direction: column;
    }

    .modal-content .text-area {
        flex-grow: 1; /* ë‚¨ì€ ê³µê°„ì„ í…ìŠ¤íŠ¸ ì˜ì—­ì´ ì±„ìš°ë„ë¡ */
        margin-bottom: 15px;
        padding: 10px;
        border: 1px solid #e2e8f0;
        border-radius: 4px;
        white-space: pre-wrap; /* ê³µë°± ë° ì¤„ë°”ê¿ˆ ìœ ì§€ */
        word-break: break-word; /* ê¸´ ë‹¨ì–´ ìë™ ì¤„ë°”ê¿ˆ */
        overflow-y: auto; /* í…ìŠ¤íŠ¸ ë‚´ìš© ìŠ¤í¬ë¡¤ */
        max-height: 60vh; /* ëª¨ë‹¬ ë‚´ ìµœëŒ€ ë†’ì´ (ë·°í¬íŠ¸ ë†’ì´ ê¸°ì¤€) */
        resize: vertical; /* ì„¸ë¡œ í¬ê¸° ì¡°ì ˆ ê°€ëŠ¥ */
        min-height: 150px; /* ìµœì†Œ ë†’ì´ ì¦ê°€ */
    }

    .modal-content .button-group {
        text-align: center;
    }

    /* OCR ì˜µì…˜ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
    #ocrOptionsContainer {
        margin-left: 1rem; /* OCR ë³€í™˜ ë²„íŠ¼ê³¼ì˜ ê°„ê²© */
        margin-right: 1rem; /* ì´ˆê¸°í™” ë²„íŠ¼ê³¼ì˜ ê°„ê²© */
    }

  </style>
</head>
<body>
  <div class="container">
    <h1 class="text-2xl font-bold mb-4">PDF ì´ë¯¸ì§€ ë³€í™˜ê¸° + OCR PDF ë‹¤ìš´ë¡œë“œ</h1>

    <div id="dropZone" class="border-2 border-dashed border-gray-300 p-6 rounded-lg text-gray-600 cursor-pointer mb-4">
      ì—¬ê¸°ì— PDF íŒŒì¼ì„ ë“œë˜ê·¸ ì•¤ ë“œë¡­í•˜ê±°ë‚˜ í´ë¦­í•´ì„œ ì„ íƒí•˜ì„¸ìš”
    </div>
    <input type="file" id="pdfInput" accept="application/pdf" class="hidden">

    <div class="mb-4 flex justify-center items-center">
      <button id="downloadImageBtn" class="action-btn primary-btn" disabled>ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ (ZIP)</button>
      <button id="ocrTriggerBtn" class="action-btn primary-btn" disabled>OCR ë³€í™˜</button> <div id="ocrOptionsContainer" class="flex items-center hidden">
           <select id="languageSelect" class="ml-4">
              <option value="kor+eng">í•œêµ­ì–´+ì˜ì–´</option>
              <option value="eng">ì˜ì–´</option>
              <option value="kor">í•œêµ­ì–´</option>
              <option value="jpn">ì¼ë³¸ì–´</option>
              <option value="chi_sim">ì¤‘êµ­ì–´(ê°„ì²´)</option>
              <option value="chi_tra">ì¤‘êµ­ì–´(ë²ˆì²´)</option>
           </select>
            <select id="psmSelect" class="ml-2">
                <option value="3" selected title="ë³´í†µ ë¬¸ì„œ, í‘œë‚˜ ê·¸ë¦¼ì´ ì„ì—¬ìˆì„ ë•Œ ì¢‹ì•„ìš”.">ìë™ (ë³´í†µ ë¬¸ì„œ)</option>
                <option value="6" title="ê¸€ì”¨ë§Œ ê¸¸ê²Œ ì´ì–´ì§€ëŠ” ë¬¸ì„œì— ì¢‹ì•„ìš”. (í‘œê°€ ë§ìœ¼ë©´ ì•ˆ ì¢‹ì•„ìš”)">ë‹¨ì¼ ë¸”ë¡ (ê¸€ì”¨ë§Œ ë§ì„ ë•Œ)</option>
                <option value="1" title="ë¬¸ì„œê°€ ê¸°ìš¸ê±°ë‚˜ ëŒì•„ê°€ ìˆì„ ë•Œ ë°©í–¥ì„ ë§ì¶°ì¤˜ìš”.">ë°©í–¥ ìë™ ê°ì§€</option>
                <option value="11" title="ê´‘ê³ , í¬ìŠ¤í„°ì²˜ëŸ¼ ê¸€ì”¨ê°€ ë„ì—„ë„ì—„ í©ì–´ì ¸ ìˆì„ ë•Œ ì¢‹ì•„ìš”.">ë„ì—„ë„ì—„ ê¸€ì”¨</option>
                </select>
            <button id="startOcrBtn" class="action-btn outline-btn ml-2" disabled>ì‹œì‘</button> </div>

      <button id="resetBtn" class="action-btn primary-btn">ì´ˆê¸°í™”</button>
    </div>

    <div class="download-buttons-group hidden" id="ocrActionButtons">
      <button id="downloadOcrPdfBtn" class="action-btn outline-btn" disabled>OCR ê²€ìƒ‰ ê°€ëŠ¥ PDF ë‹¤ìš´ë¡œë“œ</button>
      <button id="viewOcrTextBtn" class="action-btn outline-btn" disabled>ì„ íƒ í˜ì´ì§€ í…ìŠ¤íŠ¸ ë³´ê¸°</button>
      </div>

    <p id="selectedFileName" class="text-gray-700"></p>
    <div class="status-container">
        <p id="status" class="text-gray-600">íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
        <button id="stopBtn" class="action-btn danger-btn hidden">ì •ì§€</button>
    </div>

    <div class="mb-2 hidden" id="selectionPanel">
      <label><input type="checkbox" id="selectAll"> ì „ì²´ ì„ íƒ</label>
      <span id="selectedCount" class="ml-4 font-semibold">(ì„ íƒ: 0)</span>
      <button id="clearSelection"
      class="ml-2 hidden px-2 py-1 bg-gray-200 rounded hover:bg-gray-300 action-btn">
      ì„ íƒ í•´ì œ
      </button>
    </div>

    <div id="output" class="grid-output"></div>

    <div id="ocrTextModalOverlay" class="modal-overlay">
        <div class="modal-content">
            <textarea class="text-area" id="modalTextArea"></textarea> <div class="button-group">
                <button class="action-btn primary-btn" id="modalSaveEditedTextBtn">ìˆ˜ì • ì €ì¥</button> <button class="action-btn primary-btn" id="modalCopyTextBtn">í…ìŠ¤íŠ¸ ë³µì‚¬í•˜ê¸°</button>
                 <button id="modalDownloadTextBtn" class="action-btn primary-btn">í…ìŠ¤íŠ¸ ë‹¤ìš´ë¡œë“œ (.txt)</button> <button class="action-btn" id="modalCloseTextBtn">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

  </div>

  <script type="module">
  // ğŸ‘‡ ì•„ë˜ ì½”ë“œëŠ” index.html ë‚´ <script type="module"> íƒœê·¸ ì•ˆì— ìœ„ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤

import { getDocument } from 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.min.mjs';
// pdf-libì—ì„œ í•„ìš”í•œ ê°ì²´ ê°€ì ¸ì˜¤ê¸°
const { PDFDocument, rgb, StandardFonts } = PDFLib;

pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.worker.min.mjs';

const pdfInput = document.getElementById("pdfInput");
const dropZone = document.getElementById("dropZone");
const ocrTriggerBtn = document.getElementById("ocrTriggerBtn"); // OCR ë³€í™˜ ë²„íŠ¼ (íŠ¸ë¦¬ê±°)
const resetBtn = document.getElementById("resetBtn");
const output = document.getElementById("output");
const status = document.getElementById("status");
const selectedFileNameElement = document.getElementById("selectedFileName"); // íŒŒì¼ëª… í‘œì‹œ ìš”ì†Œ ì¶”ê°€

// ë‹¤ìš´ë¡œë“œ ë²„íŠ¼
const downloadImageBtn = document.getElementById("downloadImageBtn");
const downloadOcrPdfBtn = document.getElementById("downloadOcrPdfBtn"); // OCR PDF ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ìš”ì†Œ
// í…ìŠ¤íŠ¸ ë³´ê¸° ë²„íŠ¼
const viewOcrTextBtn = document.getElementById("viewOcrTextBtn"); // í…ìŠ¤íŠ¸ ë³´ê¸° ë²„íŠ¼ ìš”ì†Œ ì¶”ê°€

const selectAllCheckbox = document.getElementById("selectAll");
const selectedCountSpan = document.getElementById("selectedCount");
const clearSelectionBtn = document.getElementById("clearSelection");
const selectionPanel = document.getElementById("selectionPanel");

const stopBtn = document.getElementById("stopBtn"); // ì •ì§€ ë²„íŠ¼ ìš”ì†Œ ì¶”ê°€

// OCR ê´€ë ¨ ì•¡ì…˜ ë²„íŠ¼ ê·¸ë£¹
const ocrActionButtons = document.getElementById("ocrActionButtons");

// OCR ì˜µì…˜ ì»¨í…Œì´ë„ˆ ë° ë‚´ë¶€ ìš”ì†Œ
const ocrOptionsContainer = document.getElementById("ocrOptionsContainer"); // OCR ì˜µì…˜ ì»¨í…Œì´ë„ˆ
const languageSelect = document.getElementById("languageSelect"); // OCR ì–¸ì–´ ì„ íƒ ë“œë¡­ë‹¤ìš´
const psmSelect = document.getElementById("psmSelect"); // OCR PSM ì„ íƒ ë“œë¡­ë‹¤ìš´
const startOcrBtn = document.getElementById("startOcrBtn"); // ìƒˆë¡œìš´ ì‹œì‘ ë²„íŠ¼


let selectedFile = null;
let zip = null; // ì „ì²´ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œìš© zip ê°ì²´
let lastSelectedIndex = null;
let isProcessing = false; // ì‘ì—… ì§„í–‰ ìƒíƒœ í”Œë˜ê·¸
let storedOcrResults = []; // OCR ê²°ê³¼ë¥¼ ì €ì¥í•  ë°°ì—´
let isOcrCompleted = false; // OCR ì™„ë£Œ ìƒíƒœ í”Œë˜ê·¸
let currentOcrLanguage = languageSelect.value; // í˜„ì¬ ì„ íƒëœ OCR ì–¸ì–´
let currentPsm = parseInt(psmSelect.value); // í˜„ì¬ ì„ íƒëœ PSM ëª¨ë“œ (ì´ˆê¸°ê°’)
let totalPdfPages = 0; // ì „ì²´ PDF í˜ì´ì§€ ìˆ˜ ì €ì¥
let currentSelectedBlocks = []; // í˜„ì¬ OCR ë³€í™˜ ëŒ€ìƒì¸ ì„ íƒëœ ë¸”ë¡ ëª©ë¡

// PSM ë“œë¡­ë‹¤ìš´ ë³€ê²½ ì‹œ currentPsm ì—…ë°ì´íŠ¸
psmSelect.addEventListener('change', (e) => {
    currentPsm = parseInt(e.target.value);
    // PSM ë³€ê²½ ì‹œ workerë¥¼ ë‹¤ì‹œ ë¡œë“œí•  í•„ìš”ëŠ” ì—†ì§€ë§Œ,
    // ë‹¤ìŒ OCR ì‘ì—…ë¶€í„° ë³€ê²½ëœ PSMì´ ì ìš©ë©ë‹ˆë‹¤.
    // ë§Œì•½ PSM ë³€ê²½ ì¦‰ì‹œ workerë¥¼ ì¬ì„¤ì •í•˜ë ¤ë©´ ì—¬ê¸°ì— loadOcrWorker í˜¸ì¶œ ì¶”ê°€
    // loadOcrWorker(currentOcrLanguage); // ì´ ê²½ìš° await í•„ìš” ì—†ìŒ
});

// ì–¸ì–´ ë“œë¡­ë‹¤ìš´ ë³€ê²½ ì‹œ currentOcrLanguage ì—…ë°ì´íŠ¸ ë° worker ì¬ì„¤ì •
languageSelect.addEventListener('change', async (e) => {
    currentOcrLanguage = e.target.value;
    // ì–¸ì–´ ë³€ê²½ ì‹œ workerë¥¼ ì¬ì„¤ì •í•˜ì—¬ ìƒˆë¡œìš´ ì–¸ì–´ í›ˆë ¨ ë°ì´í„°ë¥¼ ë¡œë“œ
    if (worker) { // workerê°€ ì´ë¯¸ ë¡œë“œëœ ê²½ìš°ì—ë§Œ ì¬ì„¤ì •
        status.textContent = `OCR ì–¸ì–´ ë³€ê²½ ì¤‘: ${currentOcrLanguage} ë¡œë“œ...`;
        updateButtonStates(true); // ì–¸ì–´ ë¡œë“œ ì¤‘ ë²„íŠ¼ ë¹„í™œì„±í™”
        try {
             await loadOcrWorker(currentOcrLanguage);
             status.textContent = `OCR ì–¸ì–´ ë³€ê²½ ì™„ë£Œ! OCR ë¶„ì„ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
        } catch (error) {
             console.error("OCR ì–¸ì–´ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
             status.textContent = "OCR ì–¸ì–´ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
        } finally {
             updateButtonStates(false); // ì–¸ì–´ ë¡œë“œ ì™„ë£Œ/ì˜¤ë¥˜ í›„ ë²„íŠ¼ í™œì„±í™”
             // OCR ì˜µì…˜ ì»¨í…Œì´ë„ˆëŠ” ì–¸ì–´ ë³€ê²½ ì‹œì—ë„ ê³„ì† í‘œì‹œ ìœ ì§€
             ocrOptionsContainer.classList.remove("hidden");
        }
    }
});


// OCR worker ì´ˆê¸°í™” (ì„±ëŠ¥ í–¥ìƒì„ ìœ„í•´ ë¯¸ë¦¬ ë¡œë“œ)
// ì´ˆê¸° ì–¸ì–´ ì„¤ì •ì€ ì—¬ê¸°ì„œ í•˜ì§€ ì•Šê³ , OCR ë³€í™˜ ì‹œì‘ ì‹œì ì— ì„¤ì •í•©ë‹ˆë‹¤.
// const worker = await Tesseract.createWorker('kor+eng', 1, { logger: m => {} });
let worker = null; // worker ë³€ìˆ˜ë¥¼ ë‚˜ì¤‘ì— í• ë‹¹í•˜ë„ë¡ ë³€ê²½


// Tesseract worker ë¡œë“œ ë° ì–¸ì–´ ì„¤ì • í•¨ìˆ˜
async function loadOcrWorker(lang) {
    if (worker) {
        await worker.terminate(); // ê¸°ì¡´ worker ì¢…ë£Œ
    }
    // OCR ì—”ì§„ ëª¨ë“œ (OEM) ë° í˜ì´ì§€ ë¶„í•  ëª¨ë“œ (PSM) ì„¤ì •
    const ocrOptions = {
        logger: m => {
            // Tesseract ë‚´ë¶€ ì§„í–‰ ìƒíƒœ ë¡œê¹… (ì—¬ê¸°ì„œëŠ” ë¡œë”©/ì´ˆê¸°í™” ìƒíƒœë§Œ í‘œì‹œ)
            if (m.status === 'loading tesseract core' || m.status === 'initializing tesseract' || m.status === 'loading language traineddata') {
                 // worker ë¡œë”© ë° ì´ˆê¸°í™” ìƒíƒœ í‘œì‹œ
                 status.textContent = `OCR Worker ${m.status}... (${Math.round(m.progress * 100)}%)`;
            }
             // recognizing text ìƒíƒœëŠ” ë£¨í”„ ë‚´ì—ì„œ ì§ì ‘ ì²˜ë¦¬
        },
        // OCR ì„¤ì • ì¶”ê°€
        oem: 3, // Default OCR engine mode
        // PSM ê°’ì€ í˜„ì¬ ì„ íƒëœ ê°’ ì‚¬ìš©
        psm: currentPsm // ë“œë¡­ë‹¤ìš´ì—ì„œ ì„ íƒëœ PSM ê°’ ì‚¬ìš©
    };

    worker = await Tesseract.createWorker(lang, 1, ocrOptions);
}

// ì´ë¯¸ì§€ ì´ì§„í™” ì²˜ë¦¬ í•¨ìˆ˜
function binarizeImage(canvas) {
    const ctx = canvas.getContext("2d");
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const data = imageData.data;
    const threshold = 128; // ì„ê³„ê°’ ì„¤ì • (0-255)
    for (let j = 0; j < data.length; j += 4) {
        const avg = (data[j] + data[j + 1] + data[j + 2]) / 3;
        const color = avg > threshold ? 255 : 0; // ì„ê³„ê°’ ê¸°ì¤€ìœ¼ë¡œ í‘ ë˜ëŠ” ë°± ê²°ì •
        data[j] = color; // red
        data[j + 1] = color; // green
        data[j + 2] = color; // blue
    }
    ctx.putImageData(imageData, 0, 0);
}


// ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
function updateButtonStates(processing) {
    isProcessing = processing;
    const pagesExist = output.querySelectorAll(".image-block").length > 0;
    const selectedPagesExist = output.querySelectorAll(".image-block.selected").length > 0;
    const ocrProcessedPagesExist = output.querySelectorAll(".image-block.ocr-processed").length > 0; // OCR ì²˜ë¦¬ ì™„ë£Œëœ í˜ì´ì§€ ì¡´ì¬ ì—¬ë¶€

    // ì´ˆê¸° ìƒíƒœ: ëª¨ë“  ë²„íŠ¼ ë¹„í™œì„±í™” (íŒŒì¼ ì„ íƒ ì „)
    downloadImageBtn.disabled = true;
    ocrTriggerBtn.disabled = true;
    resetBtn.disabled = true;
    startOcrBtn.disabled = true; // ì‹œì‘ ë²„íŠ¼ ì´ˆê¸° ë¹„í™œì„±í™”

    // íŒŒì¼ì´ ì„ íƒëœ ê²½ìš°: ì´ˆê¸°í™” ë²„íŠ¼ë§Œ í™œì„±í™”
    if (selectedFile && !processing) {
        resetBtn.disabled = false;

        // ì„ íƒëœ í˜ì´ì§€ê°€ ìˆëŠ” ê²½ìš°: ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ, OCR ë³€í™˜, ì´ˆê¸°í™” ë²„íŠ¼ í™œì„±í™”
        if (selectedPagesExist) {
            downloadImageBtn.disabled = false;
            ocrTriggerBtn.disabled = false; // OCR ë³€í™˜ ë²„íŠ¼ í™œì„±í™” ì¡°ê±´ ë³€ê²½
        }
    }

    // OCR ì˜µì…˜ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ ìš”ì†Œ (ì–¸ì–´, PSM ë“œë¡­ë‹¤ìš´, ì‹œì‘ ë²„íŠ¼): ì‘ì—… ì¤‘ì´ ì•„ë‹ ë•Œë§Œ í™œì„±í™”
    languageSelect.disabled = processing;
    psmSelect.disabled = processing;

    // ì‹œì‘ ë²„íŠ¼: ì‘ì—… ì¤‘ì´ ì•„ë‹ˆë©°, OCR ì˜µì…˜ ì»¨í…Œì´ë„ˆê°€ í‘œì‹œë˜ì–´ ìˆê³ , ì„ íƒëœ í˜ì´ì§€ê°€ í•˜ë‚˜ë¼ë„ ìˆì„ ë•Œ í™œì„±í™”
    if (!processing && !ocrOptionsContainer.classList.contains("hidden") && selectedPagesExist) {
         startOcrBtn.disabled = false;
    }


    stopBtn.classList.toggle("hidden", !processing); // ì‘ì—… ì¤‘ì¼ ë•Œë§Œ ì •ì§€ ë²„íŠ¼ í‘œì‹œ

    // OCR ê´€ë ¨ ë²„íŠ¼ ê·¸ë£¹ í‘œì‹œ/ìˆ¨ê¹€: ì‘ì—… ì¤‘ì´ ì•„ë‹ˆê³  OCRì´ ì™„ë£Œë˜ì—ˆìœ¼ë©°, OCR ì²˜ë¦¬ëœ í˜ì´ì§€ê°€ í•˜ë‚˜ë¼ë„ ìˆì„ ë•Œ í‘œì‹œ
    ocrActionButtons.classList.toggle("hidden", processing || !isOcrCompleted || !ocrProcessedPagesExist);


    // OCR PDF ë‹¤ìš´ë¡œë“œ ë° í…ìŠ¤íŠ¸ ë³´ê¸° ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”: OCRì´ ì™„ë£Œë˜ì—ˆê³  OCR ì²˜ë¦¬ëœ í˜ì´ì§€ê°€ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©°, ì„ íƒëœ í˜ì´ì§€ê°€ í•˜ë‚˜ë¼ë„ ìˆì„ ë•Œ í™œì„±í™”
    if (!processing && isOcrCompleted && ocrProcessedPagesExist) {
         downloadOcrPdfBtn.disabled = !selectedPagesExist;
         viewOcrTextBtn.disabled = !selectedPagesExist;
         // downloadTextBtnì€ ëª¨ë‹¬ ì•ˆì— ìˆìœ¼ë¯€ë¡œ ì—¬ê¸°ì„œ ì œì–´í•˜ì§€ ì•ŠìŒ
    } else {
         downloadOcrPdfBtn.disabled = true;
         viewOcrTextBtn.disabled = true;
         // downloadTextBtnì€ ëª¨ë‹¬ ì•ˆì— ìˆìœ¼ë¯€ë¡œ ì—¬ê¸°ì„œ ì œì–´í•˜ì§€ ì•ŠìŒ
    }
}


// íŒŒì¼ ì²˜ë¦¬
async function handleFile(file) { // async í•¨ìˆ˜ë¡œ ë³€ê²½
  console.log("handleFile called with file:", file); // Added log
  if (file && file.type === "application/pdf") {
    selectedFile = file;
    output.innerHTML = "";
    selectionPanel.classList.add("hidden"); // íŒŒì¼ ì„ íƒ ì‹œ ì„ íƒ íŒ¨ë„ ìˆ¨ê¹€
    ocrActionButtons.classList.add("hidden"); // OCR ë²„íŠ¼ ê·¸ë£¹ ìˆ¨ê¹€
    ocrOptionsContainer.classList.add("hidden"); // OCR ì˜µì…˜ ì»¨í…Œì´ë„ˆ ìˆ¨ê¹€
    selectedFileNameElement.textContent = `ì„ íƒëœ íŒŒì¼: ${file.name}`; // íŒŒì¼ëª… í‘œì‹œ
    status.textContent = "PDF íŒŒì¼ì„ ì´ë¯¸ì§€ë¡œ ë³€í™˜ ì¤‘..."; // ìƒíƒœ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
    storedOcrResults = []; // ìƒˆ íŒŒì¼ ì„ íƒ ì‹œ OCR ê²°ê³¼ ì´ˆê¸°í™”
    isOcrCompleted = false; // OCR ì™„ë£Œ ìƒíƒœ ì´ˆê¸°í™”
    updateButtonStates(true); // ì´ë¯¸ì§€ ë³€í™˜ ì¤‘, ë²„íŠ¼ ë¹„í™œì„±í™” ë° ì •ì§€ ë²„íŠ¼ í‘œì‹œ
    currentSelectedBlocks = []; // ìƒˆ íŒŒì¼ ì„ íƒ ì‹œ ì´ˆê¸°í™”

    zip = new JSZip(); // ì „ì²´ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œìš© zip ê°ì²´ ì´ˆê¸°í™”

    const reader = new FileReader();
    reader.onload = async () => {
        try {
            const pdf = await getDocument(new Uint8Array(reader.result)).promise;
            totalPdfPages = pdf.numPages; // ì „ì²´ í˜ì´ì§€ ìˆ˜ ì €ì¥

            for (let i = 1; i <= pdf.numPages; i++) {
                if (!isProcessing) { // ì •ì§€ ìš”ì²­ í™•ì¸ (ì´ë¯¸ì§€ ë³€í™˜ ì¤‘ì—ë„ ì¤‘ë‹¨ ê°€ëŠ¥)
                    status.textContent = `ì‘ì—… ì¤‘ë‹¨ë¨. ${i - 1} í˜ì´ì§€ê¹Œì§€ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.`;
                    break; // ë£¨í”„ ì¤‘ë‹¨
                }

                status.textContent = `í˜ì´ì§€ ${i}/${pdf.numPages} ì´ë¯¸ì§€ ë³€í™˜ ì¤‘...`; // í˜ì´ì§€ë³„ ì§„í–‰ ìƒíƒœ ì—…ë°ì´íŠ¸

                const page = await pdf.getPage(i);
                // ì´ë¯¸ì§€ ë³€í™˜ ìŠ¤ì¼€ì¼ì„ 2.0ìœ¼ë¡œ ë†’ì—¬ OCR ì •í™•ë„ ê°œì„  ì‹œë„ (ë¯¸ë¦¬ë³´ê¸° ë° ë‹¤ìš´ë¡œë“œ ì´ë¯¸ì§€ì—ë„ ì ìš©ë¨)
                const viewport = page.getViewport({ scale: 2.0 });
                const canvas = document.createElement("canvas");
                const ctx = canvas.getContext("2d");
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                canvas.style.width = "100%";
                canvas.style.height = "auto";
                canvas.style.maxWidth = "100%";

                await page.render({ canvasContext: ctx, viewport }).promise;

                // *** ì´ë¯¸ì§€ ì „ì²˜ë¦¬ ì½”ë“œëŠ” OCR ë³€í™˜ ì‹œì ìœ¼ë¡œ ì´ë™ ***
                // ì—¬ê¸°ì„œ ì´ì§„í™” ì²˜ë¦¬ë¥¼ ì œê±°í•©ë‹ˆë‹¤.


                const block = document.createElement("div");
                block.className = "image-block";
                block.dataset.index = i; // ì›ë³¸ PDF í˜ì´ì§€ ì¸ë±ìŠ¤ ì €ì¥

                const label = document.createElement("p");
                label.textContent = `í˜ì´ì§€ ${i}`;
                block.appendChild(label);
                block.appendChild(canvas);

                const dataUrl = canvas.toDataURL("image/jpeg");
                const blob = await (await fetch(dataUrl)).blob();
                const filename = `page-${i}.jpg`;

                block.dataset.filename = filename;
                block.dataset.blobUrl = URL.createObjectURL(blob);
                block.dataset.dataUrl = dataUrl; // OCRì— ì‚¬ìš© (ì›ë³¸ ì´ë¯¸ì§€ dataUrl)

                block.addEventListener("click", (e) => handleBlockClick(e, block));

                // ì „ì²´ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œìš© zipì— íŒŒì¼ ì¶”ê°€ (ì›ë³¸ ì´ë¯¸ì§€ ì‚¬ìš©)
                zip.file(filename, blob);
                output.appendChild(block);
            }

            // ì´ë¯¸ì§€ ë³€í™˜ ì™„ë£Œ ë˜ëŠ” ì¤‘ë‹¨ í›„ ì²˜ë¦¬
            if (isProcessing) { // ì •ìƒ ì™„ë£Œëœ ê²½ìš°
                 status.textContent = "ì´ë¯¸ì§€ ë³€í™˜ ì™„ë£Œ! í˜ì´ì§€ë¥¼ ì„ íƒí•˜ê³  'OCR ë³€í™˜' ë²„íŠ¼ì„ ëˆŒëŸ¬ ì˜µì…˜ì„ í™•ì¸í•˜ì„¸ìš”."; // ë©”ì‹œì§€ ìˆ˜ì •
                 // ì´ë¯¸ì§€ ë³€í™˜ ì™„ë£Œ í›„ í˜ì´ì§€ê°€ ìƒì„±ë˜ì—ˆìœ¼ë©´ ì„ íƒ íŒ¨ë„ í‘œì‹œ
                const pagesExistAfterConversion = output.querySelectorAll(".image-block").length > 0;
                if (pagesExistAfterConversion) {
                     selectionPanel.classList.remove("hidden");
                }
            } else {
                status.textContent += " ì´ë¯¸ì§€ ë³€í™˜ì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.";
                 // ì¤‘ë‹¨ í›„ í˜ì´ì§€ê°€ ìƒì„±ë˜ì—ˆìœ¼ë©´ ì„ íƒ íŒ¨ë„ í‘œì‹œ
                const pagesExistAfterConversion = output.querySelectorAll(".image-block").length > 0;
                if (pagesExistAfterConversion) {
                     selectionPanel.classList.remove("hidden");
                }
            }
            updateButtonStates(false); // ì‘ì—… ì™„ë£Œ, ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ (ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ í™œì„±í™”)
            updateSelectionUI(); // ì„ íƒ UI ì—…ë°ì´íŠ¸

        } catch (error) {
            console.error("PDF ì´ë¯¸ì§€ ë³€í™˜ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            status.textContent = "PDF ì´ë¯¸ì§€ ë³€í™˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
            updateButtonStates(false); // ì˜¤ë¥˜ ë°œìƒ ì‹œ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        }
    };
    try {
        reader.readAsArrayBuffer(selectedFile);
    } catch (error) {
        console.error("íŒŒì¼ ì½ê¸° ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
        status.textContent = "íŒŒì¼ ì½ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ íŒŒì¼ì„ ì‹œë„í•´ë³´ì„¸ìš”.";
        updateButtonStates(false); // ì˜¤ë¥˜ ë°œìƒ ì‹œ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        // Reset file input and related state if reading fails
        pdfInput.value = "";
        selectedFile = null;
        output.innerHTML = "";
        selectionPanel.classList.add("hidden");
        ocrActionButtons.classList.add("hidden");
        ocrOptionsContainer.classList.add("hidden");
        selectedFileNameElement.textContent = "";
        storedOcrResults = [];
        isOcrCompleted = false;
        totalPdfPages = 0;
        updateButtonStates(false); // Ensure buttons are reset
        ocrTriggerBtn.disabled = true;
        downloadImageBtn.disabled = true;
        resetBtn.disabled = true;
    }


  } else {
    selectedFileNameElement.textContent = ""; // íŒŒì¼ëª… ì´ˆê¸°í™”
    status.textContent = "PDF íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.";
    selectedFile = null; // íŒŒì¼ ì„ íƒ í•´ì œ
    output.innerHTML = ""; // ë¯¸ë¦¬ë³´ê¸° ì´ˆê¸°í™”
    selectionPanel.classList.add("hidden"); // ì„ íƒ íŒ¨ë„ ìˆ¨ê¹€
    ocrActionButtons.classList.add("hidden"); // OCR ë²„íŠ¼ ê·¸ë£¹ ìˆ¨ê¹€
    ocrOptionsContainer.classList.add("hidden"); // OCR ì˜µì…˜ ì»¨í…Œì´ë„ˆ ìˆ¨ê¹€
    storedOcrResults = []; // íŒŒì¼ ì„ íƒ í•´ì œ ì‹œ OCR ê²°ê³¼ ì´ˆê¸°í™”
    isOcrCompleted = false; // OCR ì™„ë£Œ ìƒíƒœ ì´ˆê¸°í™”
    totalPdfPages = 0; // ì „ì²´ í˜ì´ì§€ ìˆ˜ ì´ˆê¸°í™”
    updateButtonStates(false); // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ (ë³€í™˜ ë¶ˆê°€ëŠ¥)
    // íŒŒì¼ì´ ì—†ìœ¼ë¯€ë¡œ ê´€ë ¨ ë²„íŠ¼ ëª¨ë‘ ë¹„í™œì„±í™”
    ocrTriggerBtn.disabled = true;
    downloadImageBtn.disabled = true;
    resetBtn.disabled = true; // íŒŒì¼ ì—†ì„ ë•Œ ì´ˆê¸°í™” ë²„íŠ¼ ë¹„í™œì„±í™”
  }
}

pdfInput.addEventListener("change", (e) => handleFile(e.target.files[0]));
dropZone.addEventListener("click", () => pdfInput.click());
dropZone.addEventListener("dragover", (e) => e.preventDefault());
dropZone.addEventListener("drop", (e) => {
  e.preventDefault();
  if (e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]);
});

// 'OCR ë³€í™˜' ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ì˜µì…˜ í‘œì‹œ/ìˆ¨ê¹€)
ocrTriggerBtn.addEventListener("click", () => {
     if (isProcessing) return; // ì‘ì—… ì¤‘ì—ëŠ” í´ë¦­ ë¬´ì‹œ

     // OCR ì˜µì…˜ ì»¨í…Œì´ë„ˆì˜ í‘œì‹œ ìƒíƒœë¥¼ í† ê¸€
     const isHidden = ocrOptionsContainer.classList.contains("hidden");
     if (isHidden) {
          ocrOptionsContainer.classList.remove("hidden");
     } else {
          ocrOptionsContainer.classList.add("hidden");
     }

     // ì˜µì…˜ ì»¨í…Œì´ë„ˆ í‘œì‹œ ìƒíƒœì— ë”°ë¼ ì‹œì‘ ë²„íŠ¼ì˜ í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
     updateButtonStates(isProcessing);
});


// ìƒˆë¡œìš´ 'ì‹œì‘' ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ì‹¤ì œ OCR ë³€í™˜ ì‹œì‘)
startOcrBtn.addEventListener("click", async () => {
  if (!selectedFile) {
    status.textContent = "ë¨¼ì € PDF íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.";
    selectedFileNameElement.textContent = "";
    return;
  }
  const pagesExist = output.querySelectorAll(".image-block").length > 0;
  if (!pagesExist) {
      status.textContent = "ì´ë¯¸ì§€ ë³€í™˜ì´ ë¨¼ì € ì™„ë£Œë˜ì–´ì•¼ í•©ë‹ˆë‹¤.";
      return;
  }
  const selectedBlocks = output.querySelectorAll(".image-block.selected"); // ì„ íƒëœ ë¸”ë¡ë§Œ ê°€ì ¸ì˜´
   if (selectedBlocks.length === 0) {
      status.textContent = "OCR ë³€í™˜í•  í˜ì´ì§€ë¥¼ í•˜ë‚˜ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.";
      return;
  }

  // í˜„ì¬ OCR ë³€í™˜ ëŒ€ìƒì¸ ì„ íƒëœ ë¸”ë¡ ëª©ë¡ì„ ì €ì¥
  currentSelectedBlocks = Array.from(selectedBlocks);


  // ìƒˆë¡œìš´ OCR ë³€í™˜ ì‹œì‘ ì‹œ ì´ì „ OCR ê²°ê³¼ ë° ìƒíƒœ ì´ˆê¸°í™”
  // ëª¨ë“  ì´ë¯¸ì§€ ë¸”ë¡ì—ì„œ ocr-processed í´ë˜ìŠ¤ ì œê±°
  output.querySelectorAll(".image-block").forEach(block => {
      block.classList.remove("ocr-processed");
      block.dataset.ocrText = ""; // ì €ì¥ëœ í…ìŠ¤íŠ¸ë„ ì´ˆê¸°í™”
  });
  storedOcrResults = []; // OCR ê²°ê³¼ ì´ˆê¸°í™”
  isOcrCompleted = false; // OCR ì™„ë£Œ ìƒíƒœ ì´ˆê¸°í™”


  status.textContent = "OCR ë¶„ì„ ì¤‘...";
  updateButtonStates(true); // OCR ë¶„ì„ ì¤‘, ë²„íŠ¼ ë¹„í™œì„±í™” ë° ì •ì§€ ë²„íŠ¼ í‘œì‹œ
  ocrActionButtons.classList.add("hidden"); // OCR ë²„íŠ¼ ê·¸ë£¹ ìˆ¨ê¹€

  // ì„ íƒëœ ì–¸ì–´ ë° PSM ëª¨ë“œë¡œ Tesseract worker ë¡œë“œ ë˜ëŠ” ì¬ì„¤ì •
  currentOcrLanguage = languageSelect.value;
  currentPsm = parseInt(psmSelect.value); // ë“œë¡­ë‹¤ìš´ì—ì„œ í˜„ì¬ ì„ íƒëœ PSM ê°’ ê°€ì ¸ì˜¤ê¸°
  await loadOcrWorker(currentOcrLanguage); // loadOcrWorker ë‚´ë¶€ì—ì„œ currentPsm ì‚¬ìš©


  try {
      const totalBlocksToProcess = currentSelectedBlocks.length;

      for (let i = 0; i < totalBlocksToProcess; i++) { // ì„ íƒëœ ë¸”ë¡ ìˆ˜ë§Œí¼ ë°˜ë³µ
          if (!isProcessing) { // ì •ì§€ ìš”ì²­ í™•ì¸
              status.textContent = `ì‘ì—… ì¤‘ë‹¨ë¨. ${i} í˜ì´ì§€ê¹Œì§€ OCR ë¶„ì„ë˜ì—ˆìŠµë‹ˆë‹¤.`;
              break; // ë£¨í”„ ì¤‘ë‹¨
          }

          const block = currentSelectedBlocks[i]; // ì €ì¥ëœ ì„ íƒëœ ë¸”ë¡ ëª©ë¡ ì‚¬ìš©
          const pageIndex = parseInt(block.dataset.index); // ì›ë³¸ PDF í˜ì´ì§€ ì¸ë±ìŠ¤
          const originalDataUrl = block.dataset.dataUrl; // ì›ë³¸ ì´ë¯¸ì§€ dataUrl ê°€ì ¸ì˜¤ê¸°

          // ì›ë³¸ ì´ë¯¸ì§€ dataUrlì„ ì‚¬ìš©í•˜ì—¬ OCR ì „ì²˜ë¦¬ë¥¼ ì ìš©í•œ ì´ë¯¸ì§€ ìƒì„±
          const tempCanvas = document.createElement('canvas');
          const tempCtx = tempCanvas.getContext('2d');
          const img = new Image();
          img.src = originalDataUrl;
          await new Promise((resolve) => { // ì´ë¯¸ì§€ ë¡œë”© ëŒ€ê¸°
              img.onload = resolve;
          });
          tempCanvas.width = img.width;
          tempCanvas.height = img.height;
          tempCtx.drawImage(img, 0, 0);

          // OCR ì „ì²˜ë¦¬ ì ìš© (ì˜ˆ: ì´ì§„í™”) - í•„ìš”ì‹œ ë‹¤ë¥¸ ì „ì²˜ë¦¬ í•¨ìˆ˜ ì¶”ê°€ ê°€ëŠ¥
          binarizeImage(tempCanvas); // ìœ„ì—ì„œ ì •ì˜í•œ ì´ì§„í™” í•¨ìˆ˜ ì‚¬ìš©

          const processedDataUrl = tempCanvas.toDataURL("image/jpeg"); // ì „ì²˜ë¦¬ëœ ì´ë¯¸ì§€ dataUrl


          // Tesseract loggerì—ì„œ ì‚¬ìš©í•  jobIdë¥¼ í˜„ì¬ ì„ íƒëœ ë¸”ë¡ì˜ ë£¨ãƒ¼ãƒ— ì¸ë±ìŠ¤ ië¡œ ì„¤ì •
          // ì´ë ‡ê²Œ í•˜ë©´ loggerì—ì„œ m.jobIdë¥¼ í†µí•´ í˜„ì¬ ì²˜ë¦¬ ì¤‘ì¸ ë¸”ë¡ì„ ê°„ì ‘ì ìœ¼ë¡œ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          // ìƒíƒœ ë©”ì‹œì§€ëŠ” loggerì—ì„œ ì—…ë°ì´íŠ¸ë˜ë¯€ë¡œ ì—¬ê¸°ì„œ í˜ì´ì§€ ë²ˆí˜¸ ì—…ë°ì´íŠ¸ëŠ” í•„ìš” ì—†ìŒ
          // status.textContent = `OCR ë¶„ì„ ì¤‘: ì „ì²´ ${totalPdfPages} í˜ì´ì§€ ì¤‘ ${pageIndex} í˜ì´ì§€ (${i + 1}/${selectedBlocks.length} ì„ íƒ í˜ì´ì§€)`; // ìƒì„¸ ì§„í–‰ ìƒíƒœ ì—…ë°ì´íŠ¸


          // ì „ì²˜ë¦¬ëœ ì´ë¯¸ì§€ dataUrlì„ ì‚¬ìš©í•˜ì—¬ OCR ìˆ˜í–‰
          // OCR ì˜µì…˜ì„ ëª…ì‹œì ìœ¼ë¡œ ì „ë‹¬ (PSM ê°’ì€ loadOcrWorkerì—ì„œ ì„¤ì •ë¨)
          // loggerëŠ” loadOcrWorkerì—ì„œ ì„¤ì •ë˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ë³„ë„ logger ì „ë‹¬ ë¶ˆí•„ìš”
          const { data: { text, words } } = await worker.recognize(processedDataUrl, { jobId: i });


          // ì¶”ì¶œëœ í…ìŠ¤íŠ¸ë¥¼ ë¸”ë¡ ìš”ì†Œì— ì €ì¥
          block.dataset.ocrText = text;
          // OCR ì™„ë£Œëœ ë¸”ë¡ì— í´ë˜ìŠ¤ ì¶”ê°€
          block.classList.add("ocr-processed");

          // OCR ì™„ë£Œëœ í˜ì´ì§€ ìˆ˜ë¥¼ ì„¸ì–´ì„œ ìƒíƒœ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
          const completedCount = output.querySelectorAll(".image-block.ocr-processed").length;
          status.textContent = `OCR ë¶„ì„ ì¤‘: ${completedCount}/${totalBlocksToProcess} í˜ì´ì§€ ì™„ë£Œ`;


          // ê¸°ì¡´ ê²°ê³¼ì— í•´ë‹¹ í˜ì´ì§€ ê²°ê³¼ê°€ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸, ì—†ìœ¼ë©´ ì¶”ê°€
          const existingResultIndex = storedOcrResults.findIndex(result => result.pageIndex === pageIndex);
          if (existingResultIndex > -1) {
               storedOcrResults[existingResultIndex] = {
                   pageIndex: pageIndex,
                   dataUrl: originalDataUrl, // OCR ê²°ê³¼ ì €ì¥ ì‹œì—ëŠ” ì›ë³¸ dataUrl ì‚¬ìš©
                   words: words,
                   text: text
               };
          } else {
              storedOcrResults.push({
                  pageIndex: pageIndex, // ì›ë³¸ PDF í˜ì´ì§€ ì¸ë±ìŠ¤
                  dataUrl: originalDataUrl, // OCR ê²°ê³¼ ì €ì¥ ì‹œì—ëŠ” ì›ë³¸ dataUrl ì‚¬ìš©
                  words: words,
                  text: text // ì €ì¥ëœ í…ìŠ¤íŠ¸ë„ í¬í•¨
              });
          }
          // í˜ì´ì§€ ì¸ë±ìŠ¤ ìˆœì„œëŒ€ë¡œ ì •ë ¬ (OCR ê²°ê³¼ê°€ ìˆœì„œëŒ€ë¡œ ì €ì¥ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ)
          storedOcrResults.sort((a, b) => a.pageIndex - b.pageIndex);


      }

      // ë£¨í”„ ì™„ë£Œ ë˜ëŠ” ì¤‘ë‹¨ í›„ ì²˜ë¦¬
      if (isProcessing) { // ì •ìƒ ì™„ë£Œëœ ê²½ìš°
          status.textContent = "OCR ë¶„ì„ ì™„ë£Œ!";
          isOcrCompleted = true; // OCR ì™„ë£Œ ìƒíƒœ í”Œë˜ê·¸ ì„¤ì •
      } else {
           status.textContent += " OCR ë¶„ì„ì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.";
      }
      updateButtonStates(false); // ì‘ì—… ì™„ë£Œ, ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
      updateSelectionUI(); // ì„ íƒ UI ì—…ë°ì´íŠ¸ (ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™” í¬í•¨)

  } catch (error) {
      console.error("OCR ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
      status.textContent = "OCR ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
      updateButtonStates(false); // ì˜¤ë¥˜ ë°œìƒ ì‹œ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
  }
});


// í˜ì´ì§€ ë¸”ë¡ í´ë¦­ í•¸ë“¤ëŸ¬
function handleBlockClick(e, block) {
  if (isProcessing) return; // ì‘ì—… ì¤‘ì—ëŠ” ì„ íƒ ë³€ê²½ ë¶ˆê°€

  // ëª¨ë‹¬ì´ ì—´ë ¤ìˆìœ¼ë©´ í´ë¦­ ë¬´ì‹œ
   if (ocrTextModalOverlay.style.display === "flex") {
      return;
   }


  e.stopPropagation();

  const allBlocks = Array.from(output.querySelectorAll(".image-block"));
  const currentIndex = parseInt(block.dataset.index);

  if (e.shiftKey && lastSelectedIndex !== null) {
    const from = Math.min(lastSelectedIndex, currentIndex);
    const to = Math.max(lastSelectedIndex, currentIndex);

    allBlocks.forEach((b) => {
      const idx = parseInt(b.dataset.index);
      if (idx >= from && idx <= to) {
        b.classList.add("selected");
      } else {
          // Shift í´ë¦­ ì‹œ ë²”ìœ„ì— í¬í•¨ë˜ì§€ ì•Šìœ¼ë©´ ì„ íƒ í•´ì œ
          b.classList.remove("selected");
      }
    });
  } else {
    // Shift í‚¤ ì—†ì´ í´ë¦­ ì‹œ í•´ë‹¹ ë¸”ë¡ì˜ ì„ íƒ ìƒíƒœë§Œ í† ê¸€
    block.classList.toggle("selected");
    lastSelectedIndex = currentIndex;
  }

  updateSelectionUI(); // í˜ì´ì§€ ì„ íƒ ìƒíƒœ ë³€ê²½ ì‹œ UI ì—…ë°ì´íŠ¸ ë° ë²„íŠ¼ ìƒíƒœ ê°±ì‹ 

  // ì„ íƒëœ í˜ì´ì§€ê°€ ì—†ìœ¼ë©´ OCR ì˜µì…˜ ì»¨í…Œì´ë„ˆ ìˆ¨ê¹€
  const selectedPagesExist = output.querySelectorAll(".image-block.selected").length > 0;
  if (!selectedPagesExist) {
      ocrOptionsContainer.classList.add("hidden");
  }
}

function updateSelectionUI() {
  const selected = output.querySelectorAll(".image-block.selected");
  const all = output.querySelectorAll(".image-block");
  selectedCountSpan.textContent = `(ì„ íƒ: ${selected.length})`;
  // ì„ íƒëœ í˜ì´ì§€ê°€ ìˆìœ¼ë©´ ì„ íƒ í•´ì œ ë²„íŠ¼ í‘œì‹œ, ì—†ìœ¼ë©´ ìˆ¨ê¹€
  clearSelectionBtn.classList.toggle("hidden", selected.length === 0);

  // ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì—…ë°ì´íŠ¸
  selectAllCheckbox.checked = selected.length === all.length && all.length > 0;

  // í˜ì´ì§€ ì„ íƒ ìƒíƒœ ë³€ê²½ ì‹œ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™” ìƒíƒœ ê°±ì‹ 
  updateButtonStates(isProcessing);
}

selectAllCheckbox.addEventListener("change", (e) => {
  if (isProcessing) return; // ì‘ì—… ì¤‘ì—ëŠ” ì„ íƒ ë³€ê²½ ë¶ˆê°€
   // ëª¨ë‹¬ì´ ì—´ë ¤ìˆìœ¼ë©´ í´ë¦­ ë¬´ì‹œ
   if (ocrTextModalOverlay.style.display === "flex") {
      return;
   }

  const all = output.querySelectorAll(".image-block");
  all.forEach((block) => block.classList.toggle("selected", e.target.checked));
  updateSelectionUI(); // í˜ì´ì§€ ì„ íƒ ìƒíƒœ ë³€ê²½ ì‹œ UI ì—…ë°ì´íŠ¸ ë° ë²„íŠ¼ ìƒíƒœ ê°±ì‹ 

  // ì „ì²´ ì„ íƒ í•´ì œ ì‹œ OCR ì˜µì…˜ ì»¨í…Œì´ë„ˆ ìˆ¨ê¹€
  if (!e.target.checked) {
      ocrOptionsContainer.classList.add("hidden");
  }
});

clearSelectionBtn.addEventListener("click", () => {
  if (isProcessing) return; // ì‘ì—… ì¤‘ì—ëŠ” ì„ íƒ ë³€ê²½ ë¶ˆê°€
   // ëª¨ë‹¬ì´ ì—´ë ¤ìˆìœ¼ë©´ í´ë¦­ ë¬´ì‹œ
   if (ocrTextModalOverlay.style.display === "flex") {
      return;
   }
  const all = output.querySelectorAll(".image-block.selected");
  all.forEach((block) => block.classList.remove("selected"));
  updateSelectionUI(); // í˜ì´ì§€ ì„ íƒ ìƒíƒœ ë³€ê²½ ì‹œ UI ì—…ë°ì´íŠ¸ ë° ë²„íŠ¼ ìƒíƒœ ê°±ì‹ 

  // ì„ íƒ í•´ì œ ë²„íŠ¼ í´ë¦­ ì‹œ OCR ì˜µì…˜ ì»¨í…Œì´ë„ˆ ìˆ¨ê¹€
  ocrOptionsContainer.classList.add("hidden");
});

// ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ì„ íƒëœ í˜ì´ì§€ë§Œ ë‹¤ìš´ë¡œë“œ)
downloadImageBtn.addEventListener("click", async () => {
    // ì´ ë²„íŠ¼ì€ updateButtonStatesì— ì˜í•´ ì‘ì—… ì¤‘ì´ ì•„ë‹ ë•Œë§Œ í™œì„±í™”ë˜ë¯€ë¡œ isProcessing í™•ì¸ì€ ë¶ˆí•„ìš”í•˜ì§€ë§Œ ì•ˆì „ì„ ìœ„í•´ ìœ ì§€
    if (isProcessing) return;

    const selected = output.querySelectorAll(".image-block.selected");
    if (selected.length === 0) {
        // ë²„íŠ¼ì´ ë¹„í™œì„±í™”ë˜ì–´ì•¼ í•˜ì§€ë§Œ í˜¹ì‹œ ëª¨ë¥¼ ê²½ìš°
        status.textContent = "ì´ë¯¸ì§€ë¥¼ ë‹¤ìš´ë¡œë“œí•  í˜ì´ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.";
        return;
    }

    status.textContent = `ì„ íƒëœ í˜ì´ì§€ (${selected.length}ê°œ) ì••ì¶• ì¤‘...`;
    const selectedZip = new JSZip();
    for (const block of selected) {
        // ì›ë³¸ Blob URL ì‚¬ìš©
        const res = await fetch(block.dataset.blobUrl);
        const blob = await res.blob();
        selectedZip.file(block.dataset.filename, blob);
    }

    try {
        const zipBlob = await selectedZip.generateAsync({ type: "blob" });
        const url = URL.createObjectURL(zipBlob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "selected-pages.zip"; // ì„ íƒëœ í˜ì´ì§€ë§Œ ë‹¤ìš´ë¡œë“œ
        document.body.appendChild(a); // Firefoxì—ì„œ í•„ìš”
        a.click();
        document.body.removeChild(a); // ë‹¤ìš´ë¡œë“œ í›„ ìš”ì†Œ ì œê±°
        URL.revokeObjectURL(url); // ë©”ëª¨ë¦¬ í•´ì œ
        status.textContent = "ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!";
    } catch (error) {
        console.error("ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
        status.textContent = "ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
    } finally {
         // ìƒíƒœ ë©”ì‹œì§€ ë³µì› ë˜ëŠ” ì´ˆê¸°í™” í•„ìš”ì‹œ ì—¬ê¸°ì— ì¶”ê°€
    }

});


resetBtn.addEventListener("click", () => {
  if (isProcessing) return; // ì‘ì—… ì¤‘ì—ëŠ” ì´ˆê¸°í™” ë¶ˆê°€

  pdfInput.value = "";
  selectedFile = null;
  output.innerHTML = "";
  selectionPanel.classList.add("hidden"); // ì´ˆê¸°í™” ì‹œ ì„ íƒ íŒ¨ë„ ìˆ¨ê¹€
  ocrActionButtons.classList.add("hidden"); // OCR ë²„íŠ¼ ê·¸ë£¹ ìˆ¨ê¹€
  ocrOptionsContainer.classList.add("hidden"); // OCR ì˜µì…˜ ì»¨í…Œì´ë„ˆ ìˆ¨ê¹€
  selectedFileNameElement.textContent = "";
  status.textContent = "ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.";
  selectAllCheckbox.checked = false;
  storedOcrResults = []; // ì´ˆê¸°í™” ì‹œ OCR ê²°ê³¼ ì´ˆê¸°í™”
  isOcrCompleted = false; // OCR ì™„ë£Œ ìƒíƒœ ì´ˆê¸°í™”
  totalPdfPages = 0; // ì „ì²´ í˜ì´ì§€ ìˆ˜ ì´ˆê¸°í™”
   // ëª¨ë“  ì´ë¯¸ì§€ ë¸”ë¡ì—ì„œ ocr-processed í´ë˜ìŠ¤ ì œê±°
  output.querySelectorAll(".image-block").forEach(block => {
      block.classList.remove("ocr-processed");
      block.dataset.ocrText = ""; // ì €ì¥ëœ í…ìŠ¤íŠ¸ë„ ì´ˆê¸°í™”
  });
  updateButtonStates(false); // ì´ˆê¸°í™” í›„ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
  // íŒŒì¼ì´ ì—†ìœ¼ë¯€ë¡œ ê´€ë ¨ ë²„íŠ¼ ëª¨ë‘ ë¹„í™œì„±í™”
  ocrTriggerBtn.disabled = true;
  downloadImageBtn.disabled = true;
  resetBtn.disabled = true; // íŒŒì¼ ì—†ì„ ë•Œ ì´ˆê¸°í™” ë²„íŠ¼ ë¹„í™œì„±í™”
});

// OCR PDF ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
downloadOcrPdfBtn.addEventListener("click", async () => {
    // ì´ ë²„íŠ¼ì€ updateButtonStatesì— ì˜í•´ ì‘ì—… ì¤‘ì´ ì•„ë‹ ë•Œë§Œ í™œì„±í™”ë˜ë¯€ë¡œ isProcessing í™•ì¸ì€ ë¶ˆí•„ìš”í•˜ì§€ë§Œ ì•ˆì „ì„ ìœ„í•´ ìœ ì§€
    if (isProcessing) return;

    const selectedBlocks = output.querySelectorAll(".image-block.ocr-processed"); // OCR ì²˜ë¦¬ ì™„ë£Œëœ ë¸”ë¡ë§Œ ê°€ì ¸ì˜´
    // ì„ íƒëœ ë¸”ë¡ì´ ì—†ìœ¼ë©´ (ë²„íŠ¼ì´ ë¹„í™œì„±í™”ë˜ì–´ì•¼ í•˜ì§€ë§Œ í˜¹ì‹œ ëª¨ë¥¼ ê²½ìš°) OCR ê²°ê³¼ê°€ ìˆìœ¼ë©´ ì „ì²´ ì‚¬ìš©
    const blocksToProcessIndices = Array.from(selectedBlocks).map(block => parseInt(block.dataset.index));


    if (blocksToProcessIndices.length === 0 || storedOcrResults.length === 0) {
        status.textContent = "OCR PDFë¡œ ë³€í™˜í•  í˜ì´ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.";
        return;
    }

    status.textContent = `OCR PDF ìƒì„± ì‹œì‘... (${blocksToProcessIndices.length} í˜ì´ì§€)`;
    // OCR PDF ìƒì„± ì¤‘ì—ëŠ” isProcessing í”Œë˜ê·¸ë¥¼ trueë¡œ ì„¤ì •í•˜ê³  ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ (ì •ì§€ ë²„íŠ¼ í‘œì‹œ ë“±)
    // PDF ìƒì„± ì¤‘ì—ëŠ” ì •ì§€ ê¸°ëŠ¥ì€ ë³µì¡í•˜ë¯€ë¡œ, ì—¬ê¸°ì„œëŠ” isProcessingì„ trueë¡œ ì„¤ì •í•˜ì§€ ì•Šê³  ìƒíƒœ ë©”ì‹œì§€ë§Œ ì—…ë°ì´íŠ¸
    // updateButtonStates(true); // PDF ìƒì„± ì¤‘ ì •ì§€ ê¸°ëŠ¥ì€ í˜„ì¬ êµ¬í˜„ë˜ì§€ ì•ŠìŒ

    const ocrResultsForPdf = storedOcrResults.filter(result =>
        blocksToProcessIndices.includes(result.pageIndex)
    ).sort((a, b) => a.pageIndex - b.pageIndex); // í˜ì´ì§€ ìˆœì„œëŒ€ë¡œ ì •ë ¬


    try {
        // ìƒˆ PDF ë¬¸ì„œ ìƒì„±
        const pdfDoc = await PDFDocument.create();
        const font = await pdfDoc.embedFont(StandardFonts.Helvetica); // í…ìŠ¤íŠ¸ ë ˆì´ì–´ì— ì‚¬ìš©í•  í°íŠ¸

        for (let i = 0; i < ocrResultsForPdf.length; i++) {
                 // PDF ìƒì„± ì¤‘ì—ëŠ” ì •ì§€ ìš”ì²­ í™•ì¸ (í˜„ì¬ëŠ” OCR ë¶„ì„ ë‹¨ê³„ì—ì„œë§Œ ì¤‘ë‹¨ í”Œë˜ê·¸ í™•ì¸)
                 // if (!isProcessing) { ... break; }


                const result = ocrResultsForPdf[i];
                const { pageIndex, dataUrl, words } = result; // dataUrlì€ ì›ë³¸ ì´ë¯¸ì§€ dataUrl


                 status.textContent = `PDFì— í˜ì´ì§€ ì¶”ê°€ ì¤‘... (í˜ì´ì§€ ${i + 1}/${ocrResultsForPdf.length})`; // í˜„ì¬ PDFì— ì¶”ê°€ ì¤‘ì¸ í˜ì´ì§€ í‘œì‹œ


                try {
                    // ì›ë³¸ ì´ë¯¸ì§€ ì‚½ì…
                    const image = await pdfDoc.embedJpg(dataUrl); // JPEG ì´ë¯¸ì§€ ì‚½ì…
                    const imageDims = image.scale(1); // ì´ë¯¸ì§€ ì›ë³¸ í¬ê¸° ì‚¬ìš©

                    // ì´ë¯¸ì§€ í¬ê¸°ì— ë§ëŠ” ìƒˆ í˜ì´ì§€ ì¶”ê°€
                    const page = pdfDoc.addPage([imageDims.width, imageDims.height]);
                    // í˜ì´ì§€ì— ì´ë¯¸ì§€ ê·¸ë¦¬ê¸°
                    page.drawImage(image, {
                        x: 0,
                        y: 0,
                        width: imageDims.width,
                        height: imageDims.height,
                    });

                    // ì¶”ì¶œëœ ë‹¨ì–´ë“¤ì„ íˆ¬ëª…í•œ í…ìŠ¤íŠ¸ ë ˆì´ì–´ë¡œ PDFì— ì¶”ê°€
                    words.forEach(word => {
                        const { bbox, text } = word;
                        if (text.trim()) { // ê³µë°±ì´ ì•„ë‹Œ í…ìŠ¤íŠ¸ë§Œ ì¶”ê°€
                            // ì´ë¯¸ì§€ ì¢Œí‘œë¥¼ PDF í˜ì´ì§€ ì¢Œí‘œë¡œ ë³€í™˜
                            // Tesseract bboxëŠ” ì´ë¯¸ì§€ ì¢Œìƒë‹¨ ê¸°ì¤€ (x0, y0) - (x1, y1)
                            // PDF-LIB drawTextëŠ” í˜ì´ì§€ ì¢Œí•˜ë‹¨ ê¸°ì¤€ (x, y)
                            // ì´ë¯¸ì§€ ë†’ì´ë¥¼ ì‚¬ìš©í•˜ì—¬ y ì¢Œí‘œ ë³€í™˜: PDF_y = Image_height - Tesseract_y1 - Tesseract_height
                            const textHeight = bbox.y1 - bbox.y0; // Tesseract bbox ë†’ì´
                            const pdfY = imageDims.height - bbox.y1; // PDF ì¢Œí•˜ë‹¨ ê¸°ì¤€ Y ì¢Œí‘œ

                            // Tesseract í°íŠ¸ í¬ê¸°ì™€ PDF í°íŠ¸ í¬ê¸° ë§¤í•‘ (ê·¼ì‚¬ì¹˜)
                            // Tesseract bbox ë†’ì´ë¥¼ PDF í°íŠ¸ í¬ê¸°ë¡œ ì‚¬ìš©
                             const fontSize = textHeight; // bbox ë†’ì´ë¥¼ í°íŠ¸ í¬ê¸°ë¡œ ì‚¬ìš©

                            page.drawText(text, {
                                x: bbox.x0, // Tesseract x0 ê·¸ëŒ€ë¡œ ì‚¬ìš©
                                y: pdfY,
                                font: font,
                                fontSize: fontSize,
                                color: rgb(0, 0, 0), // í…ìŠ¤íŠ¸ ìƒ‰ìƒì€ ê²€ì •
                                opacity: 0, // íˆ¬ëª…ë„ 0ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ ë³´ì´ì§€ ì•Šê²Œ í•¨
                            });
                        }
                    });

                } catch (error) {
                    console.error(`PDF í˜ì´ì§€ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ ë°œìƒ (í˜ì´ì§€ ${pageIndex}):`, error);
                    // ì˜¤ë¥˜ ë°œìƒ ì‹œ í•´ë‹¹ í˜ì´ì§€ëŠ” ê±´ë„ˆë›°ê±°ë‚˜ ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ PDFì— ì¶”ê°€í•  ìˆ˜ ìˆìŒ
                }
            }

             // PDF ì €ì¥ ë° ë‹¤ìš´ë¡œë“œ (PDF í˜ì´ì§€ê°€ í•˜ë‚˜ë¼ë„ ìƒì„±ëœ ê²½ìš°ì—ë§Œ ì‹œë„)
            if (pdfDoc.getPageCount() > 0) { // PDF í˜ì´ì§€ê°€ í•˜ë‚˜ë¼ë„ ìƒì„±ë˜ì—ˆìœ¼ë©´ ì €ì¥ ë° ë‹¤ìš´ë¡œë“œ
                 status.textContent = "PDF ì €ì¥ ì¤‘...";
                const pdfBytes = await pdfDoc.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = selectedFile.name.replace('.pdf', '_ocr.pdf'); // ì›ë³¸ íŒŒì¼ëª…ì— _ocr ì¶”ê°€
                document.body.appendChild(a); // Firefoxì—ì„œ í•„ìš”
                a.click();
                document.body.removeChild(a); // ë‹¤ìš´ë¡œë“œ í›„ ìš”ì†Œ ì œê±°
                URL.revokeObjectURL(url); // ë©”ëª¨ë¦¬ í•´ì œ

                status.textContent = `OCR PDF ë³€í™˜ ì™„ë£Œ!`;

            } else {
                 status.textContent = "PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì—¬ PDFë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
            }


    } catch (error) {
        console.error("OCR ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
        status.textContent = "OCR ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
    } finally {
        // PDF ìƒì„± ì™„ë£Œ/ì˜¤ë¥˜ í›„ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        updateButtonStates(false);
    }
});

// í…ìŠ¤íŠ¸ ë³´ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ëª¨ë‹¬ í‘œì‹œ)
viewOcrTextBtn.addEventListener("click", () => {
    // ì´ ë²„íŠ¼ì€ updateButtonStatesì— ì˜í•´ ì‘ì—… ì¤‘ì´ ì•„ë‹ ë•Œë§Œ í™œì„±í™”ë˜ë¯€ë¡œ isProcessing í™•ì¸ì€ ë¶ˆí•„ìš”í•˜ì§€ë§Œ ì•ˆì „ì„ ìœ„í•´ ìœ ì§€
    if (isProcessing) return;

    const selectedBlocks = output.querySelectorAll(".image-block.selected");
    if (selectedBlocks.length === 0) {
        // ì´ ë²„íŠ¼ì€ ì„ íƒëœ í˜ì´ì§€ê°€ ìˆì„ ë•Œë§Œ í™œì„±í™”ë˜ë¯€ë¡œ ì´ ê²½ìš°ëŠ” ë°œìƒí•˜ì§€ ì•Šì•„ì•¼ í•˜ì§€ë§Œ ì•ˆì „ì„ ìœ„í•´ í™•ì¸
        status.textContent = "í…ìŠ¤íŠ¸ë¥¼ ë³¼ í˜ì´ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.";
        return;
    }

    let combinedText = "";
    // ì„ íƒëœ ë¸”ë¡ì— í•´ë‹¹í•˜ëŠ” OCR ê²°ê³¼ë§Œ ì°¾ì•„ì„œ í…ìŠ¤íŠ¸ í•©ì¹˜ê¸° (í˜ì´ì§€ ìˆœì„œëŒ€ë¡œ ì •ë ¬)
    const selectedPagesIndices = Array.from(selectedBlocks).map(block => parseInt(block.dataset.index)).sort((a, b) => a - b);

    selectedPagesIndices.forEach(pageIndex => {
        const ocrResult = storedOcrResults.find(result => result.pageIndex === pageIndex);
        const ocrText = ocrResult ? ocrResult.text : 'ì¶”ì¶œëœ í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.';
        combinedText += `--- í˜ì´ì§€ ${pageIndex} ---\n\n${ocrText}\n\n`;
    });


    // ëª¨ë‹¬ì— í…ìŠ¤íŠ¸ ì±„ìš°ê¸°
    modalTextArea.value = combinedText.trim(); // textareaëŠ” value ì†ì„± ì‚¬ìš©

    // ëª¨ë‹¬ í‘œì‹œ
    ocrTextModalOverlay.style.display = "flex";

    // ëª¨ë‹¬ì´ ì—´ë¦´ ë•Œ í…ìŠ¤íŠ¸ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í™œì„±í™” (í…ìŠ¤íŠ¸ê°€ ìˆìœ¼ë©´)
    modalDownloadTextBtn.disabled = modalTextArea.value.trim().length === 0;
});

// ëª¨ë‹¬ ë³µì‚¬ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
modalCopyTextBtn.addEventListener("click", () => {
    const textToCopy = modalTextArea.value; // textareaëŠ” value ì†ì„± ì‚¬ìš©
    navigator.clipboard.writeText(textToCopy)
        .then(() => {
            modalCopyTextBtn.textContent = "ë³µì‚¬ë¨!";
            setTimeout(() => { modalCopyTextBtn.textContent = "í…ìŠ¤íŠ¸ ë³µì‚¬í•˜ê¸°"; }, 2000); // 2ì´ˆ í›„ ì›ë˜ëŒ€ë¡œ ë³µì›
        })
        .catch(err => {
            console.error('í…ìŠ¤íŠ¸ ë³µì‚¬ ì‹¤íŒ¨:', err);
            modalCopyTextBtn.textContent = "ë³µì‚¬ ì‹¤íŒ¨";
             setTimeout(() => { modalCopyTextBtn.textContent = "í…ìŠ¤íŠ¸ ë³µì‚¬í•˜ê¸°"; }, 2000); // 2ì´ˆ í›„ ì›ë˜ëŒ€ë¡œ ë³µì›
        });
});

// ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
modalCloseTextBtn.addEventListener("click", () => {
    ocrTextModalOverlay.style.display = "none";
    modalTextArea.value = ""; // ëª¨ë‹¬ ë‹«ì„ ë•Œ í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
});

// ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
ocrTextModalOverlay.addEventListener("click", (e) => {
    if (e.target === ocrTextModalOverlay) {
        ocrTextModalOverlay.style.display = "none";
        modalTextArea.value = ""; // ëª¨ë‹¬ ë‹«ì„ ë•Œ í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
    }
});

// ëª¨ë‹¬ ìˆ˜ì • ì €ì¥ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
modalSaveEditedTextBtn.addEventListener("click", () => {
    const editedText = modalTextArea.value;
    const selectedBlocks = output.querySelectorAll(".image-block.selected");

    if (selectedBlocks.length === 0) {
         // ì´ ê²½ìš°ëŠ” ë°œìƒí•˜ì§€ ì•Šì•„ì•¼ í•˜ì§€ë§Œ ì•ˆì „ì„ ìœ„í•´ í™•ì¸
         console.warn("ìˆ˜ì •í•  í˜ì´ì§€ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
         return;
    }

    // ì„ íƒëœ í˜ì´ì§€ë“¤ì˜ ocrTextë¥¼ ëª¨ë‹¬ì˜ ë‚´ìš©ìœ¼ë¡œ ì—…ë°ì´íŠ¸ (ê°„ë‹¨í•œ êµ¬í˜„)
    // ì—¬ëŸ¬ í˜ì´ì§€ê°€ ì„ íƒëœ ê²½ìš°, ëª¨ë‹¬ì˜ ì „ì²´ ë‚´ìš©ì´ ëª¨ë“  ì„ íƒëœ í˜ì´ì§€ì— ë™ì¼í•˜ê²Œ ì €ì¥ë©ë‹ˆë‹¤.
    // í˜ì´ì§€ë³„ë¡œ í¸ì§‘í•˜ë ¤ë©´ ëª¨ë‹¬ êµ¬ì¡°ë‚˜ ë¡œì§ì´ ë” ë³µì¡í•´ì ¸ì•¼ í•©ë‹ˆë‹¤.
    // ì—¬ê¸°ì„œëŠ” ì„ íƒëœ ëª¨ë“  í˜ì´ì§€ì˜ ocrTextë¥¼ ëª¨ë‹¬ ë‚´ìš©ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
    selectedBlocks.forEach(block => {
        const pageIndex = parseInt(block.dataset.index);
        block.dataset.ocrText = editedText; // ë¸”ë¡ ìš”ì†Œì˜ ocrText ì—…ë°ì´íŠ¸

        // storedOcrResults ë°°ì—´ì—ì„œë„ í•´ë‹¹ í˜ì´ì§€ì˜ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        const ocrResultIndex = storedOcrResults.findIndex(result => result.pageIndex === pageIndex);
        if (ocrResultIndex > -1) {
            storedOcrResults[ocrResultIndex].text = editedText;
        } else {
             // OCR ê²°ê³¼ê°€ ì—†ëŠ”ë° í…ìŠ¤íŠ¸ë¥¼ ìˆ˜ì •í•˜ëŠ” ê²½ìš°ëŠ” ë“œë¬¼ì§€ë§Œ, ìƒˆë¡œìš´ ê²°ê³¼ë¡œ ì¶”ê°€
             storedOcrResults.push({
                 pageIndex: pageIndex,
                 dataUrl: block.dataset.dataUrl, // ì›ë³¸ ì´ë¯¸ì§€ dataUrl ì‚¬ìš©
                 words: [], // ìˆ˜ì •ëœ í…ìŠ¤íŠ¸ì—ëŠ” ì›ë³¸ ë‹¨ì–´ ì •ë³´ê°€ ì—†ì„ ìˆ˜ ìˆìŒ
                 text: editedText
             });
             storedOcrResults.sort((a, b) => a.pageIndex - b.pageIndex); // ìˆœì„œëŒ€ë¡œ ì •ë ¬
        }
    });

    status.textContent = `ì„ íƒëœ í˜ì´ì§€ (${selectedBlocks.length}ê°œ) í…ìŠ¤íŠ¸ ìˆ˜ì • ì €ì¥ ì™„ë£Œ!`;
    // ëª¨ë‹¬ ë‹«ê¸°
    ocrTextModalOverlay.style.display = "none";
    modalTextArea.value = ""; // ëª¨ë‹¬ ë‹«ì„ ë•Œ í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
});


// ëª¨ë‹¬ í…ìŠ¤íŠ¸ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ëª¨ë‹¬ ì•ˆìœ¼ë¡œ ì´ë™)
modalDownloadTextBtn.addEventListener("click", () => {
     // ì´ ë²„íŠ¼ì€ ëª¨ë‹¬ì´ ì—´ë¦´ ë•Œ í™œì„±í™”/ë¹„í™œì„±í™”ë˜ë¯€ë¡œ isProcessing í™•ì¸ì€ ë¶ˆí•„ìš”í•˜ì§€ë§Œ ì•ˆì „ì„ ìœ„í•´ ìœ ì§€
     if (isProcessing) return;

    const textToDownload = modalTextArea.value; // ëª¨ë‹¬ í…ìŠ¤íŠ¸ ì˜ì—­ì˜ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°

    if (textToDownload.trim().length === 0) {
        status.textContent = "ë‹¤ìš´ë¡œë“œí•  í…ìŠ¤íŠ¸ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.";
        return;
    }

    const blob = new Blob([textToDownload], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    // íŒŒì¼ëª…ì€ ì„ íƒëœ í˜ì´ì§€ë“¤ì„ ê¸°ë°˜ìœ¼ë¡œ ìƒì„±í•˜ê±°ë‚˜ ê¸°ë³¸ íŒŒì¼ëª… ì‚¬ìš©
    // ì—¬ê¸°ì„œëŠ” ê°„ë‹¨í•˜ê²Œ ì›ë³¸ íŒŒì¼ëª…ì— '_ocr_text'ë¥¼ ì¶”ê°€
    a.download = selectedFile.name.replace('.pdf', '_ocr_text.txt');
    document.body.appendChild(a); // Firefoxì—ì„œ í•„ìš”
    a.click();
    document.body.removeChild(a); // ë‹¤ìš´ë¡œë“œ í›„ ìš”ì†Œ ì œê±°
    URL.revokeObjectURL(url); // ë©”ëª¨ë¦¬ í•´ì œ

    // ìƒíƒœ ë©”ì‹œì§€ëŠ” ëª¨ë‹¬ ë‹«ê¸° í›„ ì—…ë°ì´íŠ¸í•˜ëŠ” ê²ƒì´ ìì—°ìŠ¤ëŸ¬ì›€
    // status.textContent = `í…ìŠ¤íŠ¸ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!`;
});


// ì •ì§€ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
stopBtn.addEventListener("click", () => {
    if (isProcessing) {
        isProcessing = false; // í”Œë˜ê·¸ë§Œ ë³€ê²½í•˜ì—¬ ë£¨í”„ ì¤‘ë‹¨ ìš”ì²­
        status.textContent = "ì‘ì—… ì¤‘ë‹¨ë¨..."; // ìƒíƒœ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
        stopBtn.disabled = true; // ì¤‘ë‹¨ ìš”ì²­ í›„ ë²„íŠ¼ ë¹„í™œì„±í™”
        // Tesseract workerì—ê²Œë„ ì¤‘ë‹¨ ìš”ì²­ (í•„ìš”í•˜ë‹¤ë©´)
        // worker.terminate(); // ì´ ê²½ìš° workerë¥¼ ë‹¤ì‹œ ìƒì„±í•´ì•¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        // ê°„ë‹¨í•˜ê²ŒëŠ” í”Œë˜ê·¸ í™•ì¸ìœ¼ë¡œ ë£¨í”„ë¥¼ ì¤‘ë‹¨í•˜ëŠ” ë°©ì‹ì´ ë” êµ¬í˜„í•˜ê¸° ì‰½ìŠµë‹ˆë‹¤.
    }
});


// ë“œë˜ê·¸ë¡œ ì„ íƒí•˜ê¸°
let isSelecting = false;
let startX, startY;
let selectBox = null;

output.addEventListener("mousedown", (e) => {
  if (isProcessing) return; // ì‘ì—… ì¤‘ì—ëŠ” ì„ íƒ ë¶ˆê°€

  // ëª¨ë‹¬ì´ ì—´ë ¤ìˆìœ¼ë©´ í´ë¦­ ë¬´ì‹œ
   if (ocrTextModalOverlay.style.display === "flex") {
      return;
   }


  e.stopPropagation();

  // ë§ˆìš°ìŠ¤ ì™¼ìª½ ë²„íŠ¼ í´ë¦­ì´ ì•„ë‹ˆê±°ë‚˜ image-block ë‚´ë¶€ì—ì„œ ì‹œì‘ëœ í´ë¦­ì´ë©´ ë“œë˜ê·¸ ì„ íƒ ì‹œì‘ ì•ˆí•¨
  if (e.button !== 0 || e.target.closest(".image-block")) {
      return;
  }

  isSelecting = true;
  const rect = output.getBoundingClientRect();
  startX = e.clientX - rect.left;
  startY = e.clientY - rect.top;

  selectBox = document.createElement("div");
  Object.assign(selectBox.style, {
    position: "absolute",
    zIndex: 1000,
    border: "2px dashed #4299e1",
    backgroundColor: "rgba(66,153,225,0.2)",
    left: `${startX}px`,
    top: `${startY}px`,
    width: `0px`,
    height: `0px`,
    pointerEvents: "none" // ë“œë˜ê·¸ ë°•ìŠ¤ ìœ„ì—ì„œ ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ì§€ ì•Šë„ë¡ í•¨
  });
  output.appendChild(selectBox);
});

output.addEventListener("mousemove", (e) => {
  if (!isSelecting) return;
  const rect = output.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  const boxX = Math.min(startX, x);
  const boxY = Math.min(startY, y);
  const boxW = Math.abs(startX - x);
  const boxH = Math.abs(startY - y);
  Object.assign(selectBox.style, {
    left: `${boxX}px`,
    top: `${boxY}px`,
    width: `${boxW}px`,
    height: `${boxH}px`
  });

  // ë“œë˜ê·¸ ì¤‘ ì‹¤ì‹œê°„ìœ¼ë¡œ ì„ íƒ ì˜ì—­ ì—…ë°ì´íŠ¸ (ì„ íƒëœ ë¸”ë¡ ì‹œê°ì ìœ¼ë¡œ í‘œì‹œ)
  const currentRect = { x1: boxX, y1: boxY, x2: boxX + boxW, y2: boxY + boxH };
  const blocks = output.querySelectorAll(".image-block");
  blocks.forEach((block) => {
        // ë“œë˜ê·¸ ì„ íƒ ì¤‘ì—ëŠ” ì‘ì—… ì¤‘ í”Œë˜ê·¸ë¥¼ í™•ì¸í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
      const bRect = block.getBoundingClientRect();
      const outputRect = output.getBoundingClientRect(); // output ê¸°ì¤€ ì¢Œí‘œ ê³„ì‚°
      const bx1 = bRect.left - outputRect.left;
      const by1 = bRect.top - outputRect.top;
      const bx2 = bx1 + bRect.width;
      const by2 = by1 + bRect.height;

      const blockRect = { x1: bx1, y1: by1, x2: bx2, y2: by2 };

      // ë‘ ì‚¬ê°í˜•ì´ ê²¹ì¹˜ëŠ”ì§€ í™•ì¸
      const intersects = !(blockRect.x2 < currentRect.x1 || blockRect.x1 > currentRect.x2 || blockRect.y2 < currentRect.y1 || blockRect.y1 > currentRect.y2);

      // ë“œë˜ê·¸ ì„ íƒ ì¤‘ì—ëŠ” ë§ˆìš°ìŠ¤ ë‹¤ìš´ ì‹œì ì˜ ì„ íƒ ìƒíƒœë¥¼ ìœ ì§€í•˜ì§€ ì•Šê³  ë“œë˜ê·¸ ì˜ì—­ì— í¬í•¨ëœ ê²ƒë§Œ ì„ íƒ í‘œì‹œ
      if (intersects) {
          block.classList.add("selected");
      } else {
          // ë“œë˜ê·¸ ì˜ì—­ì—ì„œ ë²—ì–´ë‚œ ê²½ìš° ì„ íƒ í•´ì œ
          block.classList.remove("selected");
        }
    });
  updateSelectionUI(); // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ í›„ UI ìƒíƒœ ê°±ì‹ 
});

output.addEventListener("mouseup", (e) => {
  if (!isSelecting) return;
  isSelecting = false;

  // ë“œë˜ê·¸ ë°•ìŠ¤ ì œê±°
  if (selectBox) {
      selectBox.remove();
      selectBox = null;
  }

  // mousemoveì—ì„œ ì´ë¯¸ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ í–ˆìœ¼ë¯€ë¡œ mouseupì—ì„œëŠ” ì¶”ê°€ì ì¸ ì„ íƒ ë¡œì§ í•„ìš” ì—†ìŒ
  // updateSelectionUI(); // mousemoveì—ì„œ ì´ë¯¸ í˜¸ì¶œë¨
});

// ë“œë˜ê·¸ ì¤‘ ë“œë˜ê·¸ ë°•ìŠ¤ ë°–ìœ¼ë¡œ ë§ˆìš°ìŠ¤ê°€ ë‚˜ê°€ë„ ì„ íƒ í•´ì œë˜ì§€ ì•Šë„ë¡ windowì— mousemove, mouseup ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
window.addEventListener("mousemove", (e) => {
    if (!isSelecting || !selectBox) return;
    // output div ê¸°ì¤€ ì¢Œí‘œ ê³„ì‚°
    const outputRect = output.getBoundingClientRect();
    const x = e.clientX - outputRect.left;
    const y = e.clientY - outputRect.top;

    const boxX = Math.min(startX, x);
    const boxY = Math.min(startY, y);
    const boxW = Math.abs(startX - x);
    const boxH = Math.abs(startY - y);

     Object.assign(selectBox.style, {
        left: `${boxX}px`,
        top: `${boxY}px`,
        width: `${boxW}px`,
        height: `${boxH}px`
      });

    // ë“œë˜ê·¸ ì¤‘ ì‹¤ì‹œê°„ìœ¼ë¡œ ì„ íƒ ì˜ì—­ ì—…ë°ì´íŠ¸ (ì„ íƒëœ ë¸”ë¡ ì‹œê°ì ìœ¼ë¡œ í‘œì‹œ)
    const currentRect = { x1: boxX, y1: boxY, x2: boxX + boxW, y2: boxY + boxH };
    const blocks = output.querySelectorAll(".image-block");
    blocks.forEach((block) => {
        const bRect = block.getBoundingClientRect();
        const blockRect = { x1: bRect.left - outputRect.left, y1: bRect.top - outputRect.top, x2: (bRect.left - outputRect.left) + bRect.width, y2: (bRect.top - outputRect.top) + bRect.height };

        const intersects = !(blockRect.x2 < currentRect.x1 || blockRect.x1 > currentRect.x2 || blockRect.y2 < currentRect.y1 || blockRect.y1 > currentRect.y2);

        if (intersects) {
            block.classList.add("selected");
        } else {
            block.classList.remove("selected");
        }
    });
     updateSelectionUI();
});

window.addEventListener("mouseup", (e) => {
    if (!isSelecting) return;
    isSelecting = false;

    if (selectBox) {
        selectBox.remove();
        selectBox = null;
    }
    // updateSelectionUI(); // mousemove/window mousemoveì—ì„œ ì´ë¯¸ í˜¸ì¶œë¨
});


  </script>
</body>
</html>
